name: Deploy to K3s

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  IMAGE_NAME: productservice-backend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .
        docker build -t ${{ env.IMAGE_NAME }}:latest .

    - name: Save Docker image
      run: |
        docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} > productservice-image.tar

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.K3S_HOST }}
        username: ${{ secrets.K3S_USER }}
        key: ${{ secrets.K3S_SSH_KEY }}
        source: "productservice-image.tar,k8s/"
        target: "/tmp/productservice-deploy/"

    - name: Deploy to K3s
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.K3S_HOST }}
        username: ${{ secrets.K3S_USER }}
        key: ${{ secrets.K3S_SSH_KEY }}
        script: |
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² ProductService åˆ° K3s..."
          
          cd /tmp/productservice-deploy/
          
          # åŠ è½½ Docker é•œåƒåˆ° containerd
          echo "åŠ è½½ Docker é•œåƒ..."
          sudo k3s ctr images import productservice-image.tar
          
          # æ›´æ–°éƒ¨ç½²é…ç½®ä¸­çš„é•œåƒæ ‡ç­¾
          echo "æ›´æ–°éƒ¨ç½²é…ç½®..."
          sed -i "s|productservice-backend:latest|${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}|g" k8s/backend-deployment.yaml
          sed -i "s|imagePullPolicy: IfNotPresent|imagePullPolicy: Never|g" k8s/backend-deployment.yaml
          
          # åˆ é™¤æ—§çš„éƒ¨ç½²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "æ¸…ç†æ—§éƒ¨ç½²..."
          sudo kubectl delete -f k8s/ --ignore-not-found=true
          sleep 5
          
          # å…ˆéƒ¨ç½²æ•°æ®åº“æœåŠ¡
          echo "éƒ¨ç½²æ•°æ®åº“æœåŠ¡..."
          if [ -f k8s/db-service.yaml ]; then
            sudo kubectl apply -f k8s/db-service.yaml
          fi
          if [ -f k8s/postgres-data-persistentvolumeclaim.yaml ]; then
            sudo kubectl apply -f k8s/postgres-data-persistentvolumeclaim.yaml
          fi
          if [ -f k8s/db-deployment.yaml ]; then
            sudo kubectl apply -f k8s/db-deployment.yaml
          fi
          
          # ç­‰å¾…æ•°æ®åº“å°±ç»ª
          echo "ç­‰å¾…æ•°æ®åº“æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # éƒ¨ç½²åç«¯åº”ç”¨
          echo "éƒ¨ç½²åç«¯åº”ç”¨..."
          sudo kubectl apply -f k8s/backend-deployment.yaml
          sudo kubectl apply -f k8s/backend-service.yaml
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
          sudo kubectl wait --for=condition=ready pod -l io.kompose.service=backend --timeout=300s
          
          # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
          echo "æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
          sudo kubectl get pods -l io.kompose.service=backend
          sudo kubectl get services
          
          # é…ç½®æœåŠ¡æš´éœ²ï¼ˆå¦‚æœéœ€è¦ï¼‰
          echo "é…ç½®æœåŠ¡è®¿é—®..."
          sudo kubectl patch service backend -p '{"spec":{"type":"NodePort"}}'
          
          # æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
          echo ""
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "æœåŠ¡çŠ¶æ€:"
          sudo kubectl get pods,svc -l io.kompose.service=backend
          
          # è·å–æœåŠ¡è®¿é—®åœ°å€
          NODE_PORT=$(sudo kubectl get service backend -o jsonpath='{.spec.ports[0].nodePort}')
          NODE_IP=$(hostname -I | awk '{print $1}')
          echo "åç«¯æœåŠ¡è®¿é—®åœ°å€: http://$NODE_IP:$NODE_PORT"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/productservice-deploy/

    - name: Health Check
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.K3S_HOST }}
        username: ${{ secrets.K3S_USER }}
        key: ${{ secrets.K3S_SSH_KEY }}
        script: |
          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          
          # ç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ª
          sleep 30
          
          # è·å–æœåŠ¡åœ°å€
          NODE_PORT=$(sudo kubectl get service backend -o jsonpath='{.spec.ports[0].nodePort}')
          NODE_IP=$(hostname -I | awk '{print $1}')
          
          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
          for i in {1..5}; do
            if curl -f http://$NODE_IP:$NODE_PORT/health/ 2>/dev/null; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            else
              echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... ($i/5)"
              sleep 10
            fi
          done
          
          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "æœ€ç»ˆéƒ¨ç½²çŠ¶æ€:"
          sudo kubectl get pods,svc -l io.kompose.service=backend

    - name: Rollback on failure
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.K3S_HOST }}
        username: ${{ secrets.K3S_USER }}
        key: ${{ secrets.K3S_SSH_KEY }}
        script: |
          echo "ğŸ”„ éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
          
          # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
          sudo kubectl rollout undo deployment/backend
          sudo kubectl rollout status deployment/backend --timeout=300s
          
          echo "å›æ»šå®Œæˆï¼Œå½“å‰çŠ¶æ€:"
          sudo kubectl get pods -l io.kompose.service=backend

    - name: Cleanup
      if: always()
      run: |
        rm -f productservice-image.tar

    - name: Notify deployment result
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        message: |
          ProductService K3s éƒ¨ç½²å®Œæˆ
          ç¯å¢ƒ: ${{ inputs.environment || 'staging' }}
          çŠ¶æ€: ${{ job.status }}
          æäº¤: ${{ github.sha }}
          ä½œè€…: ${{ github.actor }}
          é•œåƒ: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
