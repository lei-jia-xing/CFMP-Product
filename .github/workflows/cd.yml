name: ProductService_CD

on:
  push:
    branches: [master]
    # åªæœ‰å½“CIé€šè¿‡å¹¶ä¸”ä»£ç å·²ç»åˆå…¥masteræ—¶æ‰è§¦å‘CD
  workflow_run:
    workflows: ["ProductService_CI"]
    types:
      - completed
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # åªæœ‰å½“CI workflowæˆåŠŸå®Œæˆæ—¶æ‰è¿è¡Œéƒ¨ç½²
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Images for Deployment
        run: |
          echo "ğŸ”¨ å¼ºåˆ¶é‡æ–°æ„å»ºProductServiceé•œåƒ..."
          # æ„å»ºProductServiceåç«¯é•œåƒï¼Œä½¿ç”¨commit SHAä½œä¸ºå”¯ä¸€æ ‡ç­¾
          docker build --no-cache -t productservice-backend:${{ github.sha }} .
          docker tag productservice-backend:${{ github.sha }} productservice-backend:latest
          
          echo "ğŸ“¥ æ‹‰å–PostgreSQLé•œåƒ..."
          # æ‹‰å–PostgreSQLé•œåƒ
          docker pull postgres:14
          
          echo "ğŸ’¾ ä¿å­˜é•œåƒæ–‡ä»¶..."
          # ä¿å­˜é•œåƒï¼Œä½¿ç”¨æ–°çš„æ–‡ä»¶å
          docker save productservice-backend:latest | gzip > product-service.tar.gz
          docker save postgres:14 | gzip > product-db.tar.gz
          
          echo "âœ… é•œåƒæ„å»ºå®Œæˆï¼Œç‰ˆæœ¬: ${{ github.sha }}"

      - name: Create K3s deployment package
        run: |
          mkdir -p k3s-deploy
          cp -r k8s/* k3s-deploy/
          cp product-service.tar.gz k3s-deploy/
          cp product-db.tar.gz k3s-deploy/
          cp docker-compose.yml k3s-deploy/
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > k3s-deploy/deploy-to-k3s.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² ProductService åˆ° K3s..."
          echo "ğŸ“¦ éƒ¨ç½²ç‰ˆæœ¬: ${{ github.sha }}"
          echo "ğŸ”§ éƒ¨ç½²æ—¶é—´: $(date)"
          
          # è®¾ç½®kubectlåˆ«å
          alias kubectl='k3s kubectl'
          
          # åŠ è½½Dockeré•œåƒåˆ°K3s
          echo "ğŸ“¥ åŠ è½½Dockeré•œåƒ..."
          
          # å…ˆåˆ é™¤æ—§é•œåƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "ğŸ—‘ï¸ æ¸…ç†æ—§é•œåƒ..."
          k3s ctr images rm docker.io/library/productservice-backend:latest 2>/dev/null || true
          
          echo "å¯¼å…¥ProductServiceåç«¯é•œåƒ..."
          k3s ctr images import product-service.tar.gz
          echo "å¯¼å…¥PostgreSQLæ•°æ®åº“é•œåƒ..."
          k3s ctr images import product-db.tar.gz
          
          # éªŒè¯é•œåƒå¯¼å…¥
          echo "ğŸ” éªŒè¯é•œåƒå¯¼å…¥..."
          k3s ctr images list | grep -E "(productservice-backend|postgres)"
          
          # åº”ç”¨K8sé…ç½®
          echo "ğŸ”§ åº”ç”¨K8sé…ç½®..."
          k3s kubectl apply -f postgres-data-persistentvolumeclaim.yaml
          k3s kubectl apply -f db-deployment.yaml
          k3s kubectl apply -f db-service.yaml
          
          # ç­‰å¾…æ•°æ®åº“å¯åŠ¨
          echo "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
          k3s kubectl wait --for=condition=ready pod -l io.kompose.service=product-db --timeout=300s || {
            echo "âŒ æ•°æ®åº“å¯åŠ¨è¶…æ—¶ï¼Œæ£€æŸ¥æ—¥å¿—..."
            k3s kubectl describe pod -l io.kompose.service=product-db
            k3s kubectl logs -l io.kompose.service=product-db --tail=50
            exit 1
          }
          
          # éƒ¨ç½²åç«¯æœåŠ¡
          echo "ğŸ”§ éƒ¨ç½²åç«¯æœåŠ¡..."
          
          # å…ˆåˆ é™¤æ—§çš„éƒ¨ç½²ï¼ˆå¼ºåˆ¶æ›´æ–°ï¼‰
          echo "ğŸ”„ å¼ºåˆ¶æ›´æ–°éƒ¨ç½²..."
          k3s kubectl delete deployment product-service 2>/dev/null || true
          k3s kubectl delete pods -l io.kompose.service=product-service 2>/dev/null || true
          
          # ç­‰å¾…æ—§Podå®Œå…¨åˆ é™¤
          echo "â³ ç­‰å¾…æ—§Podæ¸…ç†..."
          k3s kubectl wait --for=delete pod -l io.kompose.service=product-service --timeout=60s || true
          
          # éƒ¨ç½²æ–°ç‰ˆæœ¬
          k3s kubectl apply -f backend-deployment.yaml
          k3s kubectl apply -f backend-service.yaml
          
          # ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
          k3s kubectl wait --for=condition=ready pod -l io.kompose.service=product-service --timeout=300s || {
            echo "âŒ åç«¯æœåŠ¡å¯åŠ¨è¶…æ—¶ï¼Œæ£€æŸ¥æ—¥å¿—..."
            k3s kubectl describe pod -l io.kompose.service=product-service
            k3s kubectl logs -l io.kompose.service=product-service --tail=50
            exit 1
          }
          
          # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
          echo "ğŸ“Š æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
          k3s kubectl get pods
          k3s kubectl get services
          
          # è·å–æœåŠ¡ç«¯å£
          NODE_PORT=$(k3s kubectl get service product-service -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "30800")
          echo "âœ… ProductService éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: http://101.132.163.45:$NODE_PORT"
          echo "ğŸ’š å¥åº·æ£€æŸ¥: http://101.132.163.45:$NODE_PORT/health/"
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          for i in {1..10}; do
            if curl -f http://localhost:$NODE_PORT/health/ > /dev/null 2>&1; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
              break
            elif [ $i -eq 10 ]; then
              echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†æœåŠ¡å¯èƒ½ä»åœ¨å¯åŠ¨ä¸­"
              echo "ğŸ“‹ æœ€è¿‘çš„Podæ—¥å¿—:"
              k3s kubectl logs -l io.kompose.service=product-service --tail=20
            else
              echo "â³ ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨... ($i/10)"
              sleep 15
            fi
          done
          
          echo "ğŸ‰ ProductService CD éƒ¨ç½²æµç¨‹å®Œæˆï¼"
          EOF
          
          chmod +x k3s-deploy/deploy-to-k3s.sh
          
          # æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶
          tar -czf ProductService.tar.gz k3s-deploy/

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to K3s Server
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨..."
          
          # ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨
          sshpass -p "${{ secrets.ECS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            ProductService.tar.gz \
            root@${{ secrets.ECS_IP }}:/tmp/
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²
          sshpass -p "${{ secrets.ECS_PASSWORD }}" ssh -o StrictHostKeyChecking=no root@${{ secrets.ECS_IP }} "
            echo 'ğŸ”§ å¼€å§‹æœåŠ¡å™¨ç«¯éƒ¨ç½²...'
            
            # å¤‡ä»½æ—§ç‰ˆæœ¬
            if [ -d ~/ProductService ]; then
              echo 'ğŸ“¦ å¤‡ä»½æ—§ç‰ˆæœ¬...'
              mv ~/ProductService ~/ProductService.backup.\$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            fi
            
            # è§£å‹æ–°çš„éƒ¨ç½²åŒ…
            cd ~
            tar -xzf /tmp/ProductService.tar.gz
            mv k3s-deploy ProductService
            cd ProductService
            
            echo 'ğŸš€ æ‰§è¡Œéƒ¨ç½²è„šæœ¬...'
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            ./deploy-to-k3s.sh
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/ProductService.tar.gz
            
            echo 'âœ… K3s ProductService éƒ¨ç½²å®Œæˆ!'
            echo 'ğŸ“Š æœ€ç»ˆæœåŠ¡çŠ¶æ€:'
            k3s kubectl get pods,services | grep product
          "
          
          echo "ğŸ‰ CD éƒ¨ç½²æµç¨‹å®Œæˆï¼"

      - name: Deployment Summary
        run: |
          echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦:"
          echo "ğŸ”– ç‰ˆæœ¬: ${{ github.sha }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "â° æ—¶é—´: $(date)"
          echo "ğŸŒ è®¿é—®åœ°å€: http://101.132.163.45:30800"
          echo "ğŸ’š å¥åº·æ£€æŸ¥: http://101.132.163.45:30800/health/"
